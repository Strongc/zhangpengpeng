<html lang="en">
<head>
<title>In-line Coding - MIT/GNU Scheme 9.0</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="MIT/GNU Scheme 9.0">
<meta name="generator" content="makeinfo 4.13">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Declarations.html#Declarations" title="Declarations">
<link rel="prev" href="Standard-Names.html#Standard-Names" title="Standard Names">
<link rel="next" href="Replacement-of-Operators.html#Replacement-of-Operators" title="Replacement of Operators">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
This manual documents the use of MIT/GNU Scheme 9.0.

Copyright (C) 1986, 1987, 1988, 1989, 1990, 1991, 1992, 1993,
    1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002, 2003, 2004,
    2005, 2006, 2007, 2008, 2009, 2010 Massachusetts Institute of
    Technology

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.2 or any later version published by the Free Software
     Foundation; with no Invariant Sections, with the Front-Cover Texts
     being ``A GNU Manual,'' and with the Back-Cover Texts as in (a)
     below.  A copy of the license is included in the section entitled
     ``GNU Free Documentation License.''

     (a) The FSF's Back-Cover Text is: ``You have freedom to copy and
     modify this GNU Manual, like GNU software.  Copies published by
     the Free Software Foundation raise funds for GNU development.''
   -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<a name="In-line-Coding"></a>
<a name="In_002dline-Coding"></a>
<p>
Next:&nbsp;<a rel="next" accesskey="n" href="Replacement-of-Operators.html#Replacement-of-Operators">Replacement of Operators</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="Standard-Names.html#Standard-Names">Standard Names</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Declarations.html#Declarations">Declarations</a>
<hr>
</div>

<h4 class="subsection">4.2.2 In-line Coding</h4>

<p>Another useful facility is the ability to in-line code procedure
definitions.  In fact, the compiler will perform full beta conversion,
with automatic renaming, if you request it.  Here are the relevant
declarations:

<div class="defun">
&mdash; declaration: <b>integrate</b><var> name <small class="dots">...</small><a name="index-integrate-144"></a></var><br>
<blockquote><p>The variables <var>name</var>s must be defined in the same file as this
declaration.  Any reference to one of the named variables that appears
in the same block as the declaration, or one of its descendant blocks,
will be replaced by the corresponding binding's value expression. 
</p></blockquote></div>

<div class="defun">
&mdash; declaration: <b>integrate-operator</b><var> name <small class="dots">...</small><a name="index-integrate_002doperator-145"></a></var><br>
<blockquote><p>Similar to the <code>integrate</code> declaration, except that it only
substitutes for references that appear in the operator position of a
combination.  All other references are ignored. 
</p></blockquote></div>

<div class="defun">
&mdash; declaration: <b>integrate-external</b><var> filename<a name="index-integrate_002dexternal-146"></a></var><br>
<blockquote><p>Causes the compiler to use the top-level integrations provided by
<var>filename</var>.  <var>filename</var> should not specify a file type, and the
source-code file that it names must have been previously processed by
the compiler.

        <p>If <var>filename</var> is a relative filename (the normal case), it is
interpreted as being relative to the file in which the declaration
appears.  Thus if the declaration appears in file
<samp><span class="file">/usr/cph/foo.scm</span></samp>, then the compiler looks for a file called
<samp><span class="file">/usr/cph/</span><var>filename</var><span class="file">.ext</span></samp>.

        <p>Note: When the compiler finds top-level integrations, it collects them
and outputs them into an auxiliary file with extension <samp><span class="file">.ext</span></samp>. 
This <samp><span class="file">.ext</span></samp> file is what the <code>integrate-external</code> declaration
refers to. 
</p></blockquote></div>

   <p><a name="index-define_002dintegrable-147"></a><a name="index-define-148"></a>Note that the most common use of this facility, in-line coding of
procedure definitions, requires a somewhat complicated use of these
declarations.  Because this is so common, there is a special form,
<code>define-integrable</code>, which is like <code>define</code> but performs the
appropriate declarations.  For example:

<pre class="example">     (define-integrable (foo-bar foo bar)
       (vector-ref (vector-ref foo bar) 3))
</pre>
   <p>Here is how you do the same thing without this special form: there
should be an <code>integrate-operator</code> declaration for the procedure's
name, and (internal to the procedure's definition) an <code>integrate</code>
declaration for each of the procedure's parameters, like this:

<pre class="example">     (declare (integrate-operator foo-bar))
     
     (define foo-bar
       (lambda (foo bar)
         (declare (integrate foo bar))
         (vector-ref (vector-ref foo bar) 3)))
</pre>
   <p>The reason for this complication is as follows: the
<code>integrate-operator</code> declaration finds all the references to
<code>foo-bar</code> and replaces them with the lambda expression from the
definition.  Then, the <code>integrate</code> declarations take effect because
the combination in which the reference to <code>foo-bar</code> occurred
supplies code that is substituted throughout the body of the procedure
definition.  For example:

<pre class="example">     (foo-bar (car baz) (cdr baz))
</pre>
   <p class="noindent">First use the <code>integrate-operator</code> declaration:

<pre class="example">     ((lambda (foo bar)
        (declare (integrate foo bar))
        (vector-ref (vector-ref foo bar) 3))
      (car baz)
      (cdr baz))
</pre>
   <p class="noindent">Next use the internal <code>integrate</code> declaration:

<pre class="example">     ((lambda (foo bar)
        (vector-ref (vector-ref (car baz) (cdr baz)) 3))
      (car baz)
      (cdr baz))
</pre>
   <p class="noindent">Next notice that the variables <code>foo</code> and <code>bar</code> are not used,
and eliminate them:

<pre class="example">     ((lambda ()
        (vector-ref (vector-ref (car baz) (cdr baz)) 3)))
</pre>
   <p class="noindent">Finally, remove the &lsquo;<samp><span class="samp">((lambda () ...))</span></samp>&rsquo; to produce

<pre class="example">     (vector-ref (vector-ref (car baz) (cdr baz)) 3)
</pre>
   <h5 class="subsubheading">Useful tip</h5>

<p><a name="index-integrations_002c-seeing-effects-of-149"></a>To see the effect of integration declarations (and of macros) on a
source file, pretty-print the <samp><span class="file">.bin</span></samp> file like this (be prepared
for a lot of output).

<pre class="example">     (sf "foo.scm")
     (pp (fasload "foo.bin"))
</pre>
   </body></html>

